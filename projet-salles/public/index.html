<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Horaires du jour</title>
    <link rel="stylesheet" href="resources/style.css" />
  </head>
  <body>
    <!-- Header -->
    <div class="header">
      <div class="header-info">
        <div class="selector-info">
          <!-- Logo et nom de la salle sélectionée -->
          <img
            src="resources/images/pga.png"
            alt="Logo PGA avec fond transparent"
            draggable="false"
          />
          <!-- Liste déroulante pour le choix de salle -->
          <div class="selector">
            <select id="calendar-select">
              <option value="Salle_PGA_Beau-Site_Vignerons">
                Beau-Site - Salle des Vignerons
              </option>
              <option value="Salle_PGA_Beau-Site_Colloque">
                Beau-Site - Salle Colloque
              </option>
              <option value="Salle_PGA_Beau-Site_Espace-Felix">
                Beau-Site - Salle Espace Felix
              </option>
              <option value="Salle_PGA_Beau-Site_Quart-DHeure-Vaudois">
                Beau-Site - Salle Quart d'heure Vaudois
              </option>
              <option value="Salle_PGA_Beau-Site_Veranda">
                Beau-Site - Salle Véranda
              </option>
              <option value="Salle_PGA_Bonnettes_Colloque">
                Bonnettes - Salle Colloque
              </option>
              <option value="Salle_PGA_Coteau-Muraz_Colloque">
                Coteau-Muraz - Salle Colloque
              </option>
            </select>
          </div>
        </div>

        <div class="time">
          <div id="clock"></div>
        </div>
      </div>

      <!-- Séparation horizontale -->
      <div class="line"></div>
    </div>

    <!-- Main -->
    <div class="bottom">
      <!-- Partie de gauche -->
      <div class="main">
        <h1 id="status" class="libre"></h1>
        <div class="info-main"></div>
      </div>

      <!-- Séparation -->
      <div class="middle">
        <div class="line"></div>
      </div>

      <!-- Partie de droite -->
      <div class="events"></div>
    </div>

    <script>
      const infoMain = document.querySelector(".info-main");
      const eventsContainer = document.querySelector(".events");
      const select = document.getElementById("calendar-select");
      const eventStatus = document.getElementById("status");
      const clock = document.getElementById("clock");

      setInterval(() => {
        let date = new Date();
        clock.innerHTML = date.toLocaleTimeString("fr-FR", {
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
        });
      }, 1000);

      function loadCalendar(room) {
        // Appel de l'API pour récupérer les événements de la salle sélectionnée
        fetch(`/api/calendar/${room}`)
          .then((res) => res.json())
          .then((events) => {
            if (events.length === 0) {
              infoMain.innerHTML = "<h2>Aucun événement aujourd’hui</h2>";
              eventsContainer.innerHTML =
                "<h2>Aucun événement aujourd’hui</h2>";
              eventStatus.textContent = "Libre";
              eventStatus.className = "libre";
              return;
            }

            const first = events[0];
            const now = new Date();
            const start = new Date(first.start);
            const end = new Date(first.end);
            const isInProgress = now >= start && now <= end;

            eventStatus.textContent = isInProgress ? "Occupée" : "Libre";
            eventStatus.className = isInProgress ? "occupee" : "libre";

            infoMain.innerHTML = `
              <h2>${
                isInProgress ? "Évènement en cours" : "Prochain évènement"
              }</h2>
              <div class="first-event">
              <p>
                
              <img
              src="resources/images/calendrier-b-64.png"
              alt="Logo PGA avec fond transparent"
              draggable="false"
              />
                
                ${first.summary || ""}</p>
              <p>
                
              <img
              src="resources/images/horloge-b-64.png"
              alt="Logo PGA avec fond transparent"
              draggable="false"
              />  
                
                ${start.toLocaleDateString([], {
                  day: "2-digit",
                  month: "2-digit",
                })}  ${start.toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit",
            })} - ${end.toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit",
            })}</p>
            </div>
            `;

            if (events.length > 1) {
              eventsContainer.innerHTML = "<h2>Évènements à venir</h2>";
              events.slice(1).forEach((event) => {
                const row = document.createElement("div");
                row.classList.add("event");
                row.innerHTML = `
                  <p>
                    
              <img
              src="resources/images/calendrier-w-64.png"
              alt="Logo PGA avec fond transparent"
              draggable="false"
              />

                    ${event.summary || ""}</p>
                  <p>
                    
              <img
              src="resources/images/horloge-w-64.png"
              alt="Logo PGA avec fond transparent"
              draggable="false"
              />  
                    
                    ${new Date(event.start).toLocaleDateString("fr-FR", {
                      day: "2-digit",
                      month: "2-digit",
                    })} ${new Date(event.start).toLocaleTimeString([], {
                  hour: "2-digit",
                  minute: "2-digit",
                })} - ${new Date(event.end).toLocaleTimeString([], {
                  hour: "2-digit",
                  minute: "2-digit",
                })}</p>
                `;
                eventsContainer.appendChild(row);
              });
            } else {
              eventsContainer.innerHTML = "<h2>Pas d’autres événements</h2>";
            }
          })
          .catch((err) => {
            console.error(err);
            alert("Erreur lors du chargement des horaires");
          });
      }

      loadCalendar(select.value);

      select.addEventListener("change", () => {
        loadCalendar(select.value);
      });
    </script>
  </body>
</html>
